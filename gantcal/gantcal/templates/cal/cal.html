{% extends 'cal/base.html' %}

    {% block title %} Calendar {% endblock %}
    {% block head %}
        <style>
            div#calendar{padding:5px;}
        </style>
        {% load staticfiles %}
        <script type="text/javascript" src='{% static 'fullcalendar/dist/fullcalendar.min.js' %}'></script>
        <link href="{% static "fullcalendar/dist/fullcalendar.min.css" %}" rel="stylesheet">
        <script>
            //Get and Set Params functions
            function getParams() {
                var paramArr = window.location.search.substr(1).split("&")[0] == "" ? [] : window.location.search.substr(1).split("&");
                var params = {};
                for (var i = 0; i < paramArr.length; i++) {
                    var param = paramArr[i];
                    params[param.split("=")[0]] = param.split("=")[1]
                };
                return params
            };
            function setParams(params) {
                if (params === undefined) {
                    params = {}
                }
                var i = 1,
                    locationSearch = "",
                    len = Object.keys(params).length;
                for (var param in params) {
                    if (i == 1) {
                        locationSearch += "?"
                    }
                    locationSearch += param
                    locationSearch += "="
                    locationSearch += params[param]
                    if (i < len) {
                        locationSearch += "&"
                    }
                    i += 1
                };
                window.history.pushState({}, "", "/calendar/" + locationSearch);
            };
            function setDateParam(view,element){
                var startDate = view.start,
                date = startDate.add(15,'days'),
                y = date.year(),
                m = date.month()+1,
                q = {"y":y.toString(),"m":m.toString()};
                var o = getParams();
                setParams(q);
                if((o.y != q.y) || (o.m != q.m)){location.reload();}
                };
            function dayClick(date,jsEvent,view){
                window.alert(date);
            };
            //Default filter settings
            displayTasks = false
            displayEvents = true
            function eventFilter(event,element) {
                var metaBool = true,
                isTask = event.type=="task",
                isEvent = event.type=="event";
                if(!displayTasks){
                    metaBool = metaBool && !isTask;
                };
                if(!displayEvents){
                    metaBool = metaBool && !isEvent;
                };
                return metaBool;
            };
            $(document).ready(function(){
                var now = moment(),
                events = [
                    {% for event in events %}
                        {
                            "title": "{{event.title}}",
                            "start": "{{event.start|date:"Y-m-d"}}",
                            "end": "{{event.end|date:"Y-m-d"}}",
                            "url": "{{event.get_event_url}}",
                            "type": "event"
                        },
                    {% endfor %}
                    {% for task in tasks %}
                        {
                            "title": "{{task.event.title}} task - {{task.name}}",
                            "start": "{{task.start|date:"Y-m-d"}}",
                            "end": "{{task.end|date:"Y-m-d"}}",
                            "color": "forestgreen",
                            "url": "{{task.event.get_gantt_url}}",
                            "type": "task"
                        },
                    {% endfor %}
                ];
                $('#calendar').fullCalendar({
                    weekends: false,
                    events: events,
                    //dayClick:dayClick,
                    eventRender:eventFilter,
                    header: {
                        left:   'title',
                        center: '',
                        right:  'today prevYear,prev,next,nextYear addEvent'
                    },
                    customButtons: {
                        addEvent: {
                            text: ' + ',
                            click: function() {
                                window.location.href = "{% url 'admin:cal_event_add' %}";
                            }
                        }
                    },
                    viewRender: setDateParam,
                    {% if year and month %}
                    defaultDate: moment("{{year}}"+"/"+"{{month}}"+"/01","YYYY/MM/DD"),
                    {% else %}
                    defaultDate: now,
                    {% endif %}
                });
            });
            function taskOn() {
                displayTasks = true;
                $('#calendar').fullCalendar('rerenderEvents')
            };
            function taskOff() {
                displayTasks = false;
                $('#calendar').fullCalendar('rerenderEvents')
            };
        </script>
    {% endblock %}    
    {% block content %}
    <div id="calendar">
    </div>
    {% endblock %}
